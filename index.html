<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Iron Le v4</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="manifest-placeholder">

    <style>
        /* --- 1. DESIGN TOKENS --- */
        :root {
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --primary: #0a84ff; --success: #30d158; --danger: #ff453a;
            --bg-gradient: linear-gradient(135deg, #f2f2f7 0%, #e5e5ea 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            --text-primary: #1c1c1e; --text-secondary: #8e8e93;
            --nav-bg: rgba(245, 245, 245, 0.8);
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1c1c1e 0%, #000000 100%);
            --glass-bg: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --text-primary: #ffffff; --text-secondary: #98989d;
            --nav-bg: rgba(0, 0, 0, 0.8);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0; font-family: var(--font-stack);
            background: var(--bg-gradient); background-attachment: fixed;
            color: var(--text-primary); height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 28px; padding: 24px;
            margin-bottom: 16px; box-shadow: var(--glass-shadow); position: relative; overflow: hidden;
        }

        .btn {
            background: var(--primary); color: white; border: none; padding: 16px;
            border-radius: 18px; font-size: 17px; font-weight: 600; width: 100%;
            cursor: pointer; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3); transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-small { padding: 8px 16px; font-size: 14px; width: auto; }
        
        .btn-glass {
            background: rgba(120, 120, 128, 0.12); color: var(--primary); font-weight: 600;
            padding: 10px 16px; border-radius: 14px; border: none; font-size: 14px; cursor: pointer;
        }

        .input-glass {
            background: rgba(120, 120, 128, 0.08); border: none; color: var(--text-primary);
            padding: 14px; border-radius: 14px; width: 100%; font-size: 16px; font-family: inherit; margin-bottom: 10px;
        }
        
        /* --- LAYOUT --- */
        .page {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-top: max(env(safe-area-inset-top), 40px); padding-bottom: 100px;
            display: none; opacity: 0; animation: fadeScale 0.25s forwards;
        }
        .page.active { display: block; }
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .header-area { margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; }
        h1 { font-size: 34px; font-weight: 700; margin: 0; letter-spacing: -0.8px; }
        h2 { font-size: 22px; margin: 0 0 15px 0; font-weight: 600; }
        .subtext { color: var(--text-secondary); font-size: 15px; margin-top: 4px; }

        /* --- MODULES --- */
        .workout-day-card { display: flex; align-items: center; justify-content: space-between; padding: 20px; font-weight: 600; }
        .workout-day-card.completed { border-color: rgba(48, 209, 88, 0.3); background: rgba(48, 209, 88, 0.1); }
        .day-badge { width: 44px; height: 44px; background: rgba(120,120,128,0.1); color: var(--primary); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-right: 15px; }
        .workout-day-card.completed .day-badge { background: var(--success); color: white; }

        /* Store */
        .store-card { padding: 20px; border-left: 4px solid var(--primary); }
        .store-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; background: rgba(10,132,255,0.1); color: var(--primary); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-bottom: 8px; }

        /* Editor */
        .edit-item { background: rgba(120,120,128,0.05); padding: 10px; border-radius: 12px; margin-bottom: 8px; display:flex; gap:5px;}

        /* Water & Graph */
        canvas { width: 100%; height: 220px; display: block; }
        .water-tank { height: 150px; border-radius: 20px; background: rgba(10, 132, 255, 0.1); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; margin: 20px 0; }
        .water-level { position: absolute; bottom: 0; left: 0; right: 0; background: var(--primary); opacity: 0.3; transition: height 0.5s ease; }
        .water-display { font-size: 42px; font-weight: 800; color: var(--primary); z-index: 2; }
        .log-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(120,120,128,0.1); font-size: 14px; }

        /* --- NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: var(--nav-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 100; border: 1px solid var(--glass-border);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 10px; font-weight: 500; opacity: 0.7; transition: 0.3s; width: 50px; }
        .nav-item.active { color: var(--primary); opacity: 1; transform: translateY(-2px); }
        .nav-icon { font-size: 22px; margin-bottom: 3px; }

        /* --- OVERLAYS --- */
        #timer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        #timer-overlay.active { opacity: 1; pointer-events: auto; }
        .checkbox-ios { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--text-secondary); appearance: none; outline: none; transition: 0.2s; }
        .checkbox-ios:checked { background: var(--success); border-color: var(--success); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E"); }
    </style>
</head>
<body>

    <div id="view-home" class="page active">
        <div class="header-area">
            <div>
                <div class="subtext" id="date-display">...</div>
                <h1 id="user-greeting">Ol√°!</h1>
            </div>
            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary);" onclick="navTo('profile')">
                <img id="header-avatar" src="" style="width:100%; height:100%; object-fit: cover;">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn-glass" style="flex:1" onclick="navTo('store')">üõí Lojinha</button>
            <button class="btn-glass" style="flex:1" onclick="openEditor()">‚úèÔ∏è Personalizar</button>
        </div>

        <div id="days-container"></div>
    </div>

    <div id="view-store" class="page">
        <div class="header-area">
            <h1>Lojinha</h1>
        </div>
        <div class="glass-panel text-center">
             <p class="subtext">Carregar cat√°logo externo?</p>
             <button class="btn-glass" onclick="document.getElementById('file-store-upload').click()">üìÇ Carregar JSON</button>
             <input type="file" id="file-store-upload" hidden accept=".json" onchange="handleStoreUpload(this)">
        </div>
        <div id="store-list"></div>
    </div>

    <div id="view-editor" class="page">
        <div class="header-area">
            <button class="btn-glass btn-small" onclick="navTo('home')">Cancelar</button>
            <h2 style="margin:0">Editar</h2>
            <button class="btn-glass btn-small" style="color:var(--success)" onclick="saveEditor()">Salvar</button>
        </div>
        <div class="glass-panel">
            <label class="subtext">Nome do Treino</label>
            <input id="edit-plan-title" class="input-glass">
            <button class="btn-glass btn-small" onclick="editorAddDay()">+ Adicionar Dia</button>
        </div>
        <div id="editor-days-container"></div>
    </div>

    <div id="view-body" class="page">
        <div class="header-area"><h1>Corpo</h1></div>
        <div class="glass-panel">
            <h2>Hidrata√ß√£o</h2>
            <div class="water-tank">
                <div class="water-level" id="water-fill" style="height: 0%"></div>
                <div class="water-display"><span id="water-today-val">0</span><span style="font-size:16px">ml</span></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-glass" onclick="addWater(250)">+ 250ml</button>
                <button class="btn-glass" onclick="addWater(500)">+ 500ml</button>
            </div>
            <div style="margin-top:20px; max-height:100px; overflow-y:auto;" id="water-log-list"></div>
        </div>
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between;">
                <h2>Peso</h2>
                <span id="current-weight-display" class="subtext" style="color:var(--primary); font-weight:bold;">-- kg</span>
            </div>
            <canvas id="weightCanvas"></canvas>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <input type="date" id="weight-date-input" class="input-glass" style="flex:2;">
                <input type="number" id="weight-val-input" class="input-glass" placeholder="kg" style="flex:1;">
            </div>
            <button class="btn" onclick="addWeightLog()">Registrar Peso</button>
        </div>
    </div>

    <div id="view-history" class="page">
        <div class="header-area"><h1>Hist√≥rico</h1></div>
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; text-align:center;">
                <div><div style="font-size:24px; font-weight:bold;" id="stat-total-workouts">0</div><div class="subtext">Treinos</div></div>
                <div><div style="font-size:24px; font-weight:bold;" id="stat-streak">0</div><div class="subtext">Sequ√™ncia</div></div>
                <div><div style="font-size:24px; font-weight:bold;" id="stat-this-month">0</div><div class="subtext">Este M√™s</div></div>
            </div>
        </div>
        <div id="history-list-container"></div>
    </div>

    <div id="view-profile" class="page">
        <div class="header-area"><h1>Perfil</h1></div>
        <div class="glass-panel text-center">
            <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 15px auto;">
                <img id="profile-avatar-big" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
                <div onclick="document.getElementById('file-avatar').click()" style="position:absolute; bottom:0; right:0; background:var(--bg-gradient); padding:8px; border-radius:50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">üì∑</div>
            </div>
            <input type="file" id="file-avatar" hidden accept="image/*" onchange="handleAvatar(this)">
            <input type="text" id="settings-name" class="input-glass" style="text-align:center;" onchange="saveSettings()" placeholder="Seu Nome">
        </div>
        <div class="glass-panel">
            <h2>Dados</h2>
            <button class="btn-glass" style="width:100%; margin-bottom:10px; text-align:left;" onclick="document.getElementById('file-workout-txt').click()">üìÇ Subir Treino (.txt)</button>
            <input type="file" id="file-workout-txt" hidden accept=".txt" onchange="handleTxtUpload(this)">
            
            <button class="btn-glass" style="width:100%; margin-bottom:10px; text-align:left;" onclick="exportData()">‚¨áÔ∏è Backup (JSON)</button>
            <button class="btn-glass" style="width:100%; text-align:left;" onclick="document.getElementById('file-restore').click()">‚¨ÜÔ∏è Restaurar Backup</button>
            <input type="file" id="file-restore" hidden accept=".json" onchange="handleRestore(this)">
        </div>
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Modo Escuro</span>
                <button class="btn-glass" onclick="toggleTheme()">Alternar</button>
            </div>
        </div>
        <button class="btn" style="background:var(--danger); margin-top:20px;" onclick="resetApp()">Resetar App</button>
    </div>

    <div id="view-workout" class="page">
        <div class="header-area">
            <button class="btn-glass btn-small" onclick="navTo('home')">‚Üê Voltar</button>
            <h2 id="active-day-title" style="margin:0;">Treino</h2>
        </div>
        <div id="active-exercise-list" style="padding-bottom:50px;"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')" id="nav-home"><span class="nav-icon">üî•</span>Home</div>
        <div class="nav-item" onclick="navTo('store')" id="nav-store"><span class="nav-icon">üõí</span>Loja</div>
        <div class="nav-item" onclick="navTo('body')" id="nav-body"><span class="nav-icon">üíß</span>Corpo</div>
        <div class="nav-item" onclick="navTo('history')" id="nav-history"><span class="nav-icon">üìÖ</span>Hist.</div>
        <div class="nav-item" onclick="navTo('profile')" id="nav-profile"><span class="nav-icon">‚öôÔ∏è</span>Perfil</div>
    </nav>

    <div id="timer-overlay">
        <div style="font-size:100px; font-weight:800; color:white; font-variant-numeric:tabular-nums;" id="timer-val">00:00</div>
        <div style="display:flex; gap:20px; margin-top:20px;">
            <button class="btn" style="background:rgba(255,255,255,0.2); width:auto;" onclick="addTime(10)">+10s</button>
            <button class="btn" style="background:var(--danger); width:auto;" onclick="stopTimer()">Parar</button>
        </div>
    </div>

    <script>
        // --- 1. CORE STATE ---
        const DB_KEY = 'iron_le_v4_db';
        let DB = {
            data: { workout: null, history: [] },
            user: { name: 'Le', theme: 'dark', avatar: null },
            body: { weightLog: [], waterLog: [] }
        };
        const DEFAULT_STORE = [
            { id: "base", title: "Treino B√°sico", description: "Adapta√ß√£o.", days: [{id:"A", name:"Corpo Todo", exercises:[{name:"Flex√£o", sets:"3x10", rest:60}]}] }
        ];
        let storeCatalog = [...DEFAULT_STORE];

        // --- 2. INIT ---
        window.onload = () => {
            loadDB();
            loadStoreCatalog();
            setupUI();
            renderHome();
        };

        function loadDB() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                const p = JSON.parse(saved);
                DB = { ...DB, ...p, data: {...DB.data, ...p.data}, body: {...DB.body, ...p.body} };
            }
            applyTheme();
            updateDate();
        }
        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); }
        function updateDate() {
            const d = new Date();
            const txt = d.toLocaleDateString('pt-BR', {weekday:'long', day:'numeric', month:'short'});
            document.getElementById('date-display').innerText = txt.charAt(0).toUpperCase() + txt.slice(1);
            document.getElementById('weight-date-input').value = d.toISOString().split('T')[0];
        }

        // --- 3. NAV ---
        function navTo(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if(document.getElementById('nav-' + id)) document.getElementById('nav-' + id).classList.add('active');
            
            if(id === 'body') renderBody();
            if(id === 'history') renderHistory();
            if(id === 'store') renderStore();
        }

        // --- 4. HOME & WORKOUT ---
        function renderHome() {
            const c = document.getElementById('days-container');
            if (!DB.data.workout || !DB.data.workout.days.length) {
                c.innerHTML = '<div class="glass-panel text-center subtext">Sem treino. V√° √† Lojinha ou suba um arquivo.</div>';
                return;
            }
            c.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            DB.data.workout.days.forEach(day => {
                const done = DB.data.history.some(h => h.date === today && h.dayId === day.id);
                const div = document.createElement('div');
                div.className = `glass-panel workout-day-card ${done?'completed':''}`;
                div.onclick = () => openWorkout(day.id);
                div.innerHTML = `
                    <div style="display:flex;align-items:center;"><div class="day-badge">${done?'‚úî':day.id}</div>
                    <div>${day.name}<div class="subtext" style="font-size:12px">${day.exercises.length} Ex.</div></div></div>
                    <div style="color:var(--text-secondary)">‚ûú</div>
                `;
                c.appendChild(div);
            });
        }

        function openWorkout(id) {
            const day = DB.data.workout.days.find(d => d.id === id);
            document.getElementById('active-day-title').innerText = `${day.id} - ${day.name}`;
            const list = document.getElementById('active-exercise-list');
            list.innerHTML = '';
            day.exercises.forEach((ex, i) => {
                const el = document.createElement('div');
                el.className = 'glass-panel';
                el.innerHTML = `
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                        <h3 style="margin:0;font-size:18px;">${ex.name}</h3>
                        <input type="checkbox" class="checkbox-ios" ${ex.done?'checked':''} onchange="toggleEx('${id}',${i})">
                    </div>
                    <div class="subtext" style="margin-bottom:15px;">${ex.sets} ‚Ä¢ ${ex.rest}s ‚Ä¢ Carga: <b>${ex.lastWeight||'--'}kg</b></div>
                    <div style="display:flex;gap:10px;">
                        <button class="btn-glass" onclick="startTimer(${ex.rest})">‚è≥ Descansar</button>
                        <button class="btn-glass" onclick="logWeight('${id}',${i})">‚öñÔ∏è Carga</button>
                    </div>
                `;
                list.appendChild(el);
            });
            navTo('workout');
            try{navigator.wakeLock.request('screen')}catch(e){}
        }

        function toggleEx(dId, idx) {
            const day = DB.data.workout.days.find(d=>d.id===dId);
            day.exercises[idx].done = !day.exercises[idx].done; 
            saveDB();
            if(day.exercises.every(e=>e.done)) finishWorkout(day);
        }

        function finishWorkout(day) {
            const today = new Date().toISOString().split('T')[0];
            if(!DB.data.history.some(h=>h.date===today && h.dayId===day.id)){
                DB.data.history.unshift({date:today, timestamp:Date.now(), dayId:day.id, dayName:day.name});
                saveDB(); alert(`Treino ${day.id} Finalizado!`); renderHome();
            }
        }
        function logWeight(dId, idx) {
            const w = prompt("Carga (kg):");
            if(w){ DB.data.workout.days.find(d=>d.id===dId).exercises[idx].lastWeight = w; saveDB(); openWorkout(dId); }
        }

        // --- 5. STORE & TXT & EDITOR ---
        async function loadStoreCatalog() {
            try {
                const res = await fetch('workouts.json');
                if(res.ok) storeCatalog = [...await res.json(), ...DEFAULT_STORE];
            } catch(e) { console.log("Loja offline"); }
        }
        function renderStore() {
            const l = document.getElementById('store-list'); l.innerHTML = '';
            storeCatalog.forEach(i => {
                l.innerHTML += `<div class="glass-panel store-card"><span class="store-tag">TREINO</span><h3>${i.title}</h3>
                <p class="subtext">${i.description}</p><button class="btn btn-small" style="margin-top:10px" onclick="installWorkout('${i.id}')">Instalar</button></div>`;
            });
        }
        function installWorkout(id) {
            if(confirm("Substituir treino atual?")) {
                const w = storeCatalog.find(x=>x.id===id);
                DB.data.workout = JSON.parse(JSON.stringify(w));
                saveDB(); navTo('home'); renderHome();
            }
        }
        function handleStoreUpload(inp) {
            const r = new FileReader();
            r.onload = e => { try { storeCatalog = [...JSON.parse(e.target.result), ...storeCatalog]; renderStore(); } catch(err){alert('JSON inv√°lido');} };
            r.readAsText(inp.files[0]);
        }

        // TXT PARSER
        function handleTxtUpload(inp) {
            const r = new FileReader();
            r.onload = e => {
                const txt = e.target.result;
                const lines = txt.split('\n');
                let newWorkout = { title: "Treino Importado", days: [] };
                let currentDay = null;

                lines.forEach(line => {
                    line = line.trim();
                    if(!line) return;
                    if(line.toLowerCase().startsWith('plano:')) newWorkout.title = line.split(':')[1].trim();
                    else if(line.toLowerCase().startsWith('dia:')) {
                        const parts = line.split(':');
                        const info = parts[1].trim().split('-'); // "A - Peito" -> ["A", " Peito"]
                        currentDay = { id: info[0].trim(), name: info[1]?info[1].trim():'Treino', exercises: [] };
                        newWorkout.days.push(currentDay);
                    } else if(currentDay && line.includes('|')) {
                        const parts = line.split('|');
                        currentDay.exercises.push({
                            name: parts[0].trim(),
                            sets: parts[1] ? parts[1].trim() : "3x10",
                            rest: parts[2] ? parseInt(parts[2].trim()) : 60
                        });
                    }
                });

                if(newWorkout.days.length > 0) {
                    if(confirm(`Instalar treino: ${newWorkout.title}?`)) {
                        DB.data.workout = newWorkout;
                        saveDB(); navTo('home'); renderHome();
                    }
                } else { alert("Formato inv√°lido. Use: Dia: A - Nome \n Exercicio | 3x10 | 60"); }
            };
            r.readAsText(inp.files[0]);
        }

        // VISUAL EDITOR
        let editState = null;
        function openEditor() {
            if(!DB.data.workout) DB.data.workout = {title:"Meu Treino", days:[]};
            editState = JSON.parse(JSON.stringify(DB.data.workout));
            document.getElementById('edit-plan-title').value = editState.title || '';
            renderEditor(); navTo('editor');
        }
        function renderEditor() {
            const c = document.getElementById('editor-days-container'); c.innerHTML='';
            editState.days.forEach((d, di) => {
                let exs = '';
                d.exercises.forEach((e, ei) => {
                    exs += `<div class="edit-item"><input class="input-glass" style="margin:0;flex:2" value="${e.name}" onchange="editState.days[${di}].exercises[${ei}].name=this.value">
                    <input class="input-glass" style="margin:0;flex:1" value="${e.sets}" onchange="editState.days[${di}].exercises[${ei}].sets=this.value">
                    <button class="btn-glass" style="color:var(--danger)" onclick="editDelEx(${di},${ei})">√ó</button></div>`;
                });
                c.innerHTML += `<div class="glass-panel"><div style="display:flex;gap:5px;margin-bottom:10px;">
                <input class="input-glass" style="width:50px" value="${d.id}" onchange="editState.days[${di}].id=this.value">
                <input class="input-glass" value="${d.name}" onchange="editState.days[${di}].name=this.value">
                <button class="btn-glass" style="color:var(--danger)" onclick="editDelDay(${di})">üóë</button></div>
                ${exs}<button class="btn-glass btn-small" onclick="editAddEx(${di})">+ Exercicio</button></div>`;
            });
        }
        function editAddEx(di) { editState.days[di].exercises.push({name:'', sets:'3x10', rest:60}); renderEditor(); }
        function editDelEx(di, ei) { editState.days[di].exercises.splice(ei,1); renderEditor(); }
        function editorAddDay() { editState.days.push({id:'Z', name:'Novo Dia', exercises:[]}); renderEditor(); }
        function editDelDay(di) { if(confirm('Apagar dia?')) {editState.days.splice(di,1); renderEditor();} }
        function saveEditor() {
            editState.title = document.getElementById('edit-plan-title').value;
            DB.data.workout = editState; saveDB(); navTo('home'); renderHome();
        }

        // --- 6. BODY & HISTORY & UTIL ---
        function renderBody() {
            // Water
            const today = new Date().setHours(0,0,0,0);
            const logs = DB.body.waterLog.filter(x => x.ts >= today);
            const total = logs.reduce((a,b)=>a+b.amount,0);
            document.getElementById('water-today-val').innerText = total;
            document.getElementById('water-fill').style.height = Math.min((total/3000)*100, 100)+'%';
            const l = document.getElementById('water-log-list'); l.innerHTML = '';
            logs.reverse().forEach(x=>l.innerHTML+=`<div class="log-item"><span>${new Date(x.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><b>${x.amount}ml</b></div>`);
            
            // Weight
            const wLogs = DB.body.weightLog;
            if(wLogs.length) document.getElementById('current-weight-display').innerText = wLogs[wLogs.length-1].val + ' kg';
            const cvs = document.getElementById('weightCanvas');
            const ctx = cvs.getContext('2d');
            const rect = cvs.parentNode.getBoundingClientRect(); cvs.width=rect.width*2; cvs.height=440; ctx.scale(2,2);
            ctx.clearRect(0,0,rect.width,220);
            
            if(wLogs.length>1) {
                const vals = wLogs.map(x=>x.val);
                const min = Math.min(...vals)-1; const range = Math.max(...vals)+1-min;
                const step = (rect.width-40)/(wLogs.length-1);
                ctx.beginPath();
                wLogs.forEach((x,i)=>{
                    const px = 20+i*step; const py = 220-((x.val-min)/range*180)-20;
                    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
                });
                ctx.strokeStyle='#0a84ff'; ctx.lineWidth=4; ctx.stroke();
            }
        }
        function addWater(v) { DB.body.waterLog.push({ts:Date.now(), amount:v}); saveDB(); renderBody(); }
        function addWeightLog() {
            const d = document.getElementById('weight-date-input').value;
            const v = parseFloat(document.getElementById('weight-val-input').value);
            if(d&&v) { DB.body.weightLog = DB.body.weightLog.filter(x=>x.date!==d); DB.body.weightLog.push({date:d, val:v}); 
            DB.body.weightLog.sort((a,b)=>new Date(a.date)-new Date(b.date)); saveDB(); renderBody(); }
        }

        function renderHistory() {
            const h = DB.data.history;
            document.getElementById('stat-total-workouts').innerText = h.length;
            document.getElementById('stat-this-month').innerText = h.filter(x=>x.date.startsWith(new Date().toISOString().slice(0,7))).length;
            const hl = document.getElementById('history-list-container'); hl.innerHTML = '';
            h.forEach(x => {
                hl.innerHTML += `<div class="glass-panel" style="padding:15px; display:flex; justify-content:space-between;">
                <div><b>${x.dayName}</b> (${x.dayId})</div><div class="subtext">${new Date(x.date).toLocaleDateString('pt-BR')} ‚úî</div></div>`;
            });
        }

        // Utils
        function setupUI() {
            document.getElementById('user-greeting').innerText = `Ol√°, ${DB.user.name.split(' ')[0]}`;
            document.getElementById('header-avatar').src = DB.user.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23888'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3C/svg%3E";
            document.getElementById('profile-avatar-big').src = document.getElementById('header-avatar').src;
            document.getElementById('settings-name').value = DB.user.name;
        }
        function toggleTheme() { DB.user.theme=DB.user.theme==='dark'?'light':'dark'; saveDB(); applyTheme(); }
        function applyTheme() { document.documentElement.setAttribute('data-theme', DB.user.theme); }
        function handleAvatar(i) {
            const r = new FileReader(); r.onload=e=>{
                const img=new Image(); img.onload=()=>{
                    const c=document.createElement('canvas'); c.width=150;c.height=150;
                    c.getContext('2d').drawImage(img,0,0,150,150);
                    DB.user.avatar=c.toDataURL('image/jpeg',0.7); saveDB(); setupUI();
                }; img.src=e.target.result;
            }; r.readAsDataURL(i.files[0]);
        }
        function saveSettings(){ DB.user.name=document.getElementById('settings-name').value; saveDB(); setupUI(); }
        function exportData(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(DB)],{type:'application/json'})); a.download='iron_bkp.json'; a.click(); }
        function handleRestore(i){ const r=new FileReader(); r.onload=e=>{DB=JSON.parse(e.target.result); saveDB(); location.reload();}; r.readAsText(i.files[0]); }
        function resetApp(){ if(confirm('Zerar tudo?')) { localStorage.removeItem(DB_KEY); location.reload(); } }
        
        // Timer
        let tInt;
        function startTimer(s){
            document.getElementById('timer-overlay').classList.add('active');
            let r=s; const d=document.getElementById('timer-val');
            clearInterval(tInt); d.innerText=r;
            tInt=setInterval(()=>{r--;d.innerText=r;if(r<=0)stopTimer();},1000);
        }
        function stopTimer(){ clearInterval(tInt); document.getElementById('timer-overlay').classList.remove('active'); }
        function addTime(s){ const d=document.getElementById('timer-val'); let v=parseInt(d.innerText)+s; d.innerText=v; }
    </script>
</body>
</html>